<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>관리자 대시보드 · 스크럼/노션 요약</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { overflow-x: hidden; height: 100%; }
    .card { box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    .heat-cell { height: 26px; border-radius: 6px; }
  </style>
</head>
<body class="bg-gray-50">
  <nav class="bg-white border-b">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-14">
        <div class="flex items-center gap-3">
          <button onclick="goBackToMain()" class="text-blue-600 hover:text-blue-700">← 메인으로</button>
          <h1 class="text-xl font-bold text-gray-800">관리자 페이지 · 스크럼/노션 대시보드</h1>
        </div>
        <span class="text-sm text-gray-500">데이터: 목업(샘플) · UI 검증 용</span>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-6 space-y-6">
    <section class="bg-white rounded-xl p-4 card">
      <nav class="flex gap-4 border-b pb-2">
        <button id="tab-dashboard" class="py-2 px-3 rounded text-blue-700 font-semibold border-b-2 border-blue-600">대시보드</button>
        <button id="tab-weekly" class="py-2 px-3 rounded text-gray-500 hover:text-gray-700">주간 요약</button>
        <button id="tab-daily" class="py-2 px-3 rounded text-gray-500 hover:text-gray-700">일별 스크럼</button>
        <button id="tab-student" class="py-2 px-3 rounded text-gray-500 hover:text-gray-700">수강생 상세</button>
      </nav>

      <!-- 대시보드 -->
      <div id="content-dashboard" class="pt-4 space-y-6">
        <div class="grid md:grid-cols-4 gap-3">
          <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-xs text-gray-600">이번 주 총 작성</p>
            <p id="kpi-total" class="text-2xl font-bold">-</p>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <p class="text-xs text-gray-600">평균 작성률(7일)</p>
            <p id="kpi-rate" class="text-2xl font-bold text-green-700">-</p>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <p class="text-xs text-gray-600">최다 작성</p>
            <p id="kpi-top" class="text-2xl font-bold text-purple-700">-</p>
          </div>
          <div class="bg-yellow-50 rounded-lg p-4">
            <p class="text-xs text-gray-600">미작성 일자(7일)</p>
            <p id="kpi-miss" class="text-2xl font-bold text-yellow-700">-</p>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-semibold mb-3">학생별 작성일수(최근 7일)</h3>
            <div class="flex items-center justify-end gap-2 mb-2">
              <label class="text-xs text-gray-500">표시</label>
              <select id="chartLimit" class="border px-2 py-1 rounded text-xs">
                <option value="10">Top 10</option>
                <option value="20">Top 20</option>
                <option value="0">전체</option>
              </select>
            </div>
            <div id="chartByStudentBox" style="height:320px"><canvas id="chartByStudent"></canvas></div>
          </div>
          <div class="bg-white border rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">일자별 작성률(%)</h3>
              <select id="weekSelect" class="border px-2 py-1 rounded text-sm"></select>
            </div>
            <div style="height:320px"><canvas id="chartDailyRate"></canvas></div>
          </div>
        </div>

        <div class="bg-white border rounded-xl p-4">
          <h3 class="font-semibold mb-3">참여도 히트맵(최근 7일)</h3>
          <div id="heatmapWrap" style="max-height:420px; overflow:auto;">
            <div id="heatmap" class="space-y-1"></div>
          </div>
        </div>
      </div>

      <!-- 주간 요약 -->
      <div id="content-weekly" class="pt-4 hidden">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <label class="text-sm text-gray-600">주차 선택</label>
          <select id="weeklySelect" class="border px-2 py-1 rounded text-sm"></select>
          <select id="weeklyGroupFilter" class="ml-auto border px-2 py-1 rounded text-sm">
            <option value="all">전체 조</option>
            <option value="1">1조</option>
            <option value="2">2조</option>
            <option value="3">3조</option>
            <option value="4">4조</option>
            <option value="5">5조</option>
          </select>
          <input id="weeklySearch" class="border px-2 py-1 rounded text-sm" placeholder="이름 검색" />
        </div>
        <div class="overflow-x-auto border rounded-xl">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left text-xs text-gray-500 px-4 py-2">조</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2">이름</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2 w-1/2">날짜별_작업기록</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2">요약</th>
              </tr>
            </thead>
            <tbody id="weeklyTbody" class="bg-white"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-end gap-2 mt-2 text-sm">
          <button id="weeklyPrev" class="px-2 py-1 border rounded">이전</button>
          <span id="weeklyPageInfo" class="text-gray-500"></span>
          <button id="weeklyNext" class="px-2 py-1 border rounded">다음</button>
        </div>
      </div>

      <!-- 일별 스크럼 -->
      <div id="content-daily" class="pt-4 hidden">
        <div class="flex flex-wrap items-center gap-2 mb-3">
          <label class="text-sm text-gray-600">날짜</label>
          <select id="dailySelect" class="border px-2 py-1 rounded text-sm"></select>
          <select id="dailyGroupFilter" class="ml-auto border px-2 py-1 rounded text-sm">
            <option value="all">전체 조</option>
            <option value="1">1조</option>
            <option value="2">2조</option>
            <option value="3">3조</option>
            <option value="4">4조</option>
            <option value="5">5조</option>
          </select>
          <input id="dailySearch" class="border px-2 py-1 rounded text-sm" placeholder="이름/작업 검색" />
          <button id="exportDaily" class="ml-auto bg-blue-600 text-white text-sm px-3 py-1.5 rounded">내보내기</button>
        </div>
        <div class="overflow-x-auto border rounded-xl">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left text-xs text-gray-500 px-4 py-2">이름</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2">조</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2">작업</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2">관점</th>
                <th class="text-left text-xs text-gray-500 px-4 py-2">상태</th>
              </tr>
            </thead>
            <tbody id="dailyTbody" class="bg-white"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-end gap-2 mt-2 text-sm">
          <button id="dailyPrev" class="px-2 py-1 border rounded">이전</button>
          <span id="dailyPageInfo" class="text-gray-500"></span>
          <button id="dailyNext" class="px-2 py-1 border rounded">다음</button>
        </div>
      </div>

      <!-- 수강생 상세 -->
      <div id="content-student" class="pt-4 hidden space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div class="md:col-span-2 flex items-center gap-2">
            <label class="text-sm text-gray-600">수강생</label>
            <select id="studentSelect" class="border px-2 py-1 rounded text-sm"></select>
          </div>
          <div class="flex items-center gap-2">
            <label class="text-sm text-gray-600">주차</label>
            <select id="studentWeekSelect" class="border px-2 py-1 rounded text-sm"></select>
          </div>
        </div>
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-semibold mb-3">작성 추이</h3>
            <div style="height:300px"><canvas id="chartStudent"></canvas></div>
          </div>
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-semibold mb-3">관점 분포</h3>
            <div style="height:300px"><canvas id="chartPerspective"></canvas></div>
          </div>
        </div>
        <div class="bg-white border rounded-xl p-4">
          <h3 class="font-semibold mb-3">날짜별 상세</h3>
          <div id="studentTimeline" class="space-y-3"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    function goBackToMain() {
      const currentCohort = localStorage.getItem('currentCohort') || 'ai-x-3rd';
      window.location.href = `main.html?cohort=${currentCohort}`;
    }

    // 대량 학생 스케일을 위한 페이지 사이즈
    const PAGE_SIZE = 10;

    // 목업 데이터: 노션 주간 로그 + 일별 스크럼
    let STUDENTS = [
      { name: 'Seulgi Lee', group: 1 },
      { name: 'coffee J', group: 1 },
      { name: 'han kook kim', group: 1 },
      { name: '준식 박', group: 1 },
      { name: '회원 앙', group: 1 },
      { name: '김민재', group: 2 }
    ];

    // 30명까지 확장 목업 (그룹 라운드로 분배)
    if (STUDENTS.length < 30) {
      const base = STUDENTS.slice();
      for (let i = base.length + 1; i <= 30; i++) {
        STUDENTS.push({ name: `Student ${String(i).padStart(2,'0')}`, group: (i % 5) + 1 });
      }
    }

    const WEEK_RANGE = { start: '2025-07-27', end: '2025-08-02' };

    // 주간 노션 작업기록 (샘플: 스크린샷 요약 반영)
    const WEEKLY_LOGS = [
      {
        weekKey: '2025-07-27~2025-08-02',
        summary: '노션 작업 기록 크롤링 결과, 주간 예외처리 보강·GPU 환경 개선·FAISS 통합테스트 완료 등 주요 이슈 해결.',
        items: [
          {
            name: 'Seulgi Lee', group: 1,
            logs: [
              { date: '2025-08-01', text: '유튜브 영상 분석 시 요리와 관련되지 않은 영상 예외처리.' },
              { date: '2025-07-31', text: '프로젝트룸 고민: 문제는 "이름불로하지"였다.' },
              { date: '2025-07-31', text: '스크립트에서 레시피 추출 오류 → LLM 수정하여 정상 추출.' }
            ],
            summary: '예외 처리 강화, 레시피 추출 정상화.'
          },
          {
            name: 'coffee J', group: 1,
            logs: [
              { date: '2025-07-31', text: '프로젝트룸 고민: "이름불로하지" 이슈.' },
              { date: '2025-07-30', text: 'Gemini API를 활용해 사용자 요리 관련 자연어 요청 분석 실패 원인 파악.' },
              { date: '2025-07-29', text: '이틀 디노밍 변환 해킹카드 수행.' }
            ],
            summary: '요청 의도 파악 개선 필요.'
          },
          {
            name: 'han kook kim', group: 1,
            logs: [
              { date: '2025-08-01', text: '3D게임 상품 임베딩 작업: GPU환경으로 개선해 1시간으로 단축.' },
              { date: '2025-07-31', text: '프로젝트룸 고민: "이름불로하지" 관련 이슈 기록.' },
              { date: '2025-07-30', text: 'Chroma DB 성능 튜닝 및 LLM을 위한 지식 베이스 준비.' }
            ],
            summary: 'GPU 전환으로 속도 개선, DB·지식베이스 정비.'
          },
          {
            name: '준식 박', group: 1,
            logs: [
              { date: '2025-07-31', text: '프로젝트룸 고민 작업 중 이름을 정하는 문제 논의.' },
              { date: '2025-07-31', text: 'Chroma DB 성능 최적화 및 버전 관리 이슈 해결.' },
              { date: '2025-07-30', text: '임베딩 작업 통합 테스트(Faiss) 완료.' }
            ],
            summary: '통합 테스트 완료, 정상 동작과 속도 확인.'
          },
          {
            name: '회원 앙', group: 1,
            logs: [
              { date: '2025-08-01', text: '크립톰 백엔드 서버화, 프로그램이 자체적으로 동작하도록 처리.' },
              { date: '2025-07-31', text: '프로젝트룸 고민: "이름불로하지" 기록.' },
              { date: '2025-07-29', text: '이미지피치를 json 형식으로 추출하는 구조 설계.' }
            ],
            summary: '서버화 완료, 이미지→JSON 파이프라인 설계.'
          },
          {
            name: '김민재', group: 2,
            logs: [
              { date: '2025-08-01', text: '프로토타입 기능 제작 작업 수행.' },
              { date: '2025-07-31', text: 'MongoDB 기초 조사.' },
              { date: '2025-07-30', text: '자소서 검증 기능 프로토타입 제작.' }
            ],
            summary: 'MongoDB 조사·검증도구 제작 진행.'
          }
        ]
      }
    ];

    // 일별 스크럼 (최근 7일 샘플)
    const DAYS = ['2025-07-27','2025-07-28','2025-07-29','2025-07-30','2025-07-31','2025-08-01','2025-08-02'];
    const DAILY = DAYS.reduce((acc, d) => {
      acc[d] = STUDENTS.map(s => ({
        name: s.name,
        group: s.group,
        task: sampleTaskFor(s.name, d).task,
        perspective: sampleTaskFor(s.name, d).perspective,
        status: Math.random() > 0.2 ? '완료' : '진행중'
      }));
      return acc;
    }, {});

    function sampleTaskFor(name, date){
      const tasks = [
        { task:'크롤러 예외처리', perspective:'에러 핸들링' },
        { task:'데이터 전처리', perspective:'품질/정합성' },
        { task:'모델 학습', perspective:'성능 향상' },
        { task:'UI 다듬기', perspective:'UX/접근성' },
        { task:'DB 튜닝', perspective:'성능/안정성' }
      ];
      const idx = (name.length + new Date(date).getDate()) % tasks.length;
      return tasks[idx];
    }

    // 공통 헬퍼
    function groupBy(arr, key){
      return arr.reduce((m, x) => { const k = key(x); (m[k] ||= []).push(x); return m; }, {});
    }

    // 탭 전환
    const tabs = ['dashboard','weekly','daily','student'];
    tabs.forEach(t => {
      document.getElementById(`tab-${t}`).addEventListener('click', () => {
        tabs.forEach(x => {
          document.getElementById(`tab-${x}`).className = 'py-2 px-3 rounded text-gray-500 hover:text-gray-700';
          document.getElementById(`content-${x}`).classList.add('hidden');
        });
        document.getElementById(`tab-${t}`).className = 'py-2 px-3 rounded text-blue-700 font-semibold border-b-2 border-blue-600';
        document.getElementById(`content-${t}`).classList.remove('hidden');
      });
    });

    // 초기 렌더
    document.addEventListener('DOMContentLoaded', () => {
      initSelectors();
      renderDashboard();
      renderWeeklyTable(WEEKLY_LOGS[0].weekKey);
      renderDailyTable(DAYS[DAYS.length-2]);
      renderStudentDetail(STUDENTS[0].name);
    });

    function initSelectors(){
      // 주차 셀렉터
      const weeklySel = document.getElementById('weeklySelect');
      WEEKLY_LOGS.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w.weekKey; opt.textContent = w.weekKey; weeklySel.appendChild(opt);
      });
      weeklySel.addEventListener('change', e => { weeklyPage = 0; renderWeeklyTable(e.target.value); });

      // 필터/검색 이벤트
      document.getElementById('weeklyGroupFilter').addEventListener('change', () => { weeklyPage = 0; renderWeeklyTable(weeklySel.value); });
      document.getElementById('weeklySearch').addEventListener('input', () => { weeklyPage = 0; renderWeeklyTable(weeklySel.value); });

      // 일별 셀렉터
      const dailySel = document.getElementById('dailySelect');
      DAYS.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; dailySel.appendChild(o); });
      dailySel.value = DAYS[DAYS.length-2];
      dailySel.addEventListener('change', e => { dailyPage = 0; renderDailyTable(e.target.value); });
      document.getElementById('exportDaily').addEventListener('click', () => {
        const d = document.getElementById('dailySelect').value;
        alert(`${d} 일자 스크럼을 내보냈습니다. (샘플)`);
      });
      document.getElementById('dailyGroupFilter').addEventListener('change', () => { dailyPage = 0; renderDailyTable(dailySel.value); });
      document.getElementById('dailySearch').addEventListener('input', () => { dailyPage = 0; renderDailyTable(dailySel.value); });

      // 대시보드 주차/차트 옵션
      const weekSel = document.getElementById('weekSelect');
      WEEKLY_LOGS.forEach(w => { const o=document.createElement('option'); o.value=w.weekKey; o.textContent=w.weekKey; weekSel.appendChild(o); });
      weekSel.addEventListener('change', renderDashboard);
      document.getElementById('chartLimit').addEventListener('change', renderDashboard);

      // 수강생 상세
      const stuSel = document.getElementById('studentSelect');
      STUDENTS.forEach(s => { const o=document.createElement('option'); o.value=s.name; o.textContent=s.name; stuSel.appendChild(o); });
      stuSel.addEventListener('change', e => renderStudentDetail(e.target.value));
      const stuWeek = document.getElementById('studentWeekSelect');
      WEEKLY_LOGS.forEach(w => { const o=document.createElement('option'); o.value=w.weekKey; o.textContent=w.weekKey; stuWeek.appendChild(o); });
      stuWeek.addEventListener('change', () => renderStudentDetail(stuSel.value));

      // 페이지 이동 버튼
      document.getElementById('weeklyPrev').addEventListener('click', () => { weeklyPage = Math.max(0, weeklyPage-1); renderWeeklyTable(weeklySel.value); });
      document.getElementById('weeklyNext').addEventListener('click', () => { weeklyPage = Math.min(weeklyMaxPage, weeklyPage+1); renderWeeklyTable(weeklySel.value); });
      document.getElementById('dailyPrev').addEventListener('click', () => { dailyPage = Math.max(0, dailyPage-1); renderDailyTable(dailySel.value); });
      document.getElementById('dailyNext').addEventListener('click', () => { dailyPage = Math.min(dailyMaxPage, dailyPage+1); renderDailyTable(dailySel.value); });
    }

    // 대시보드 렌더
    let chartByStudent, chartDailyRate;
    function renderDashboard(){
      const recent7 = DAYS.slice(-7);
      const participation = STUDENTS.map(s => ({
        name: s.name,
        count: recent7.filter(d => DAILY[d].some(x => x.name===s.name)).length
      }));

      // KPI
      const total = recent7.reduce((sum, d) => sum + DAILY[d].length, 0);
      document.getElementById('kpi-total').textContent = `${total} 건`;
      const ratePerDay = recent7.map(d => DAILY[d].filter(x => x.status==='완료').length / STUDENTS.length * 100);
      const avgRate = Math.round(ratePerDay.reduce((a,b)=>a+b,0)/ratePerDay.length);
      document.getElementById('kpi-rate').textContent = `${avgRate}%`;
      const top = participation.slice().sort((a,b)=>b.count-a.count)[0];
      document.getElementById('kpi-top').textContent = `${top.name}`;
      const miss = recent7.length * STUDENTS.length - total;
      document.getElementById('kpi-miss').textContent = `${miss} 건`;

      // 차트 Top-N 및 가로 막대 처리
      const limit = parseInt(document.getElementById('chartLimit').value, 10);
      let dataList = participation.slice().sort((a,b)=>b.count-a.count);
      if (limit > 0 && dataList.length > limit) dataList = dataList.slice(0, limit);

      const byStuBox = document.getElementById('chartByStudentBox');
      const needHorizontal = dataList.length > 12;
      const height = Math.max(320, 26 * dataList.length + 60);
      byStuBox.style.height = needHorizontal ? `${height}px` : '320px';

      chartByStudent && chartByStudent.destroy();
      chartByStudent = new Chart(document.getElementById('chartByStudent'), {
        type: 'bar',
        data: {
          labels: dataList.map(x=>x.name),
          datasets: [{ label: '작성일수', data: dataList.map(x=>x.count), backgroundColor: '#3B82F6' }]
        },
        options: { responsive: true, maintainAspectRatio:false, indexAxis: needHorizontal ? 'y' : 'x', plugins:{ legend:{display:false} } }
      });

      // 일자별 작성률
      const dayLabels = recent7;
      chartDailyRate && chartDailyRate.destroy();
      chartDailyRate = new Chart(document.getElementById('chartDailyRate'), {
        type: 'line',
        data: { labels: dayLabels, datasets: [{ label:'작성률(%)', data: ratePerDay, borderColor:'#10B981', backgroundColor:'rgba(16,185,129,0.15)', tension:0.35, fill:true }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } }
      });

      // 히트맵(스크롤 컨테이너 유지)
      const heat = document.getElementById('heatmap');
      heat.innerHTML = '';
      const header = document.createElement('div');
      header.className='grid grid-cols-8 gap-2 text-xs text-gray-500 mb-1';
      header.innerHTML = `<div></div>${dayLabels.map(d=>`<div class='text-center'>${d.slice(5)}</div>`).join('')}`;
      heat.appendChild(header);
      STUDENTS.forEach(s=>{
        const row = document.createElement('div');
        row.className='grid grid-cols-8 gap-2 items-center';
        row.innerHTML = `<div class='text-xs text-gray-600 truncate'>${s.name}</div>` + dayLabels.map(d=>{
          const wrote = DAILY[d].some(x => x.name===s.name);
          const done = DAILY[d].some(x => x.name===s.name && x.status==='완료');
          const color = !wrote ? 'bg-gray-100' : (done ? 'bg-green-500' : 'bg-yellow-400');
          const title = !wrote ? '미작성' : (done?'완료':'진행중');
          return `<div class='heat-cell ${color}' title='${title}'></div>`;
        }).join('');
        heat.appendChild(row);
      });
    }

    // 페이지 상태
    let weeklyPage = 0, weeklyMaxPage = 0;
    let dailyPage = 0, dailyMaxPage = 0;

    // 주간 요약 테이블
    function renderWeeklyTable(weekKey){
      const week = WEEKLY_LOGS.find(w => w.weekKey===weekKey);
      document.getElementById('weeklySelect').value = weekKey;
      const groupVal = document.getElementById('weeklyGroupFilter').value;
      const q = (document.getElementById('weeklySearch').value || '').toLowerCase();
      let list = week.items.slice();
      if (groupVal !== 'all') list = list.filter(i => String(i.group) === groupVal);
      if (q) list = list.filter(i => i.name.toLowerCase().includes(q));

      weeklyMaxPage = Math.max(0, Math.ceil(list.length / PAGE_SIZE) - 1);
      weeklyPage = Math.min(weeklyPage, weeklyMaxPage);
      const start = weeklyPage * PAGE_SIZE;
      const pageItems = list.slice(start, start + PAGE_SIZE);

      const tbody = document.getElementById('weeklyTbody');
      tbody.innerHTML = '';
      pageItems.forEach(item=>{
        const tr = document.createElement('tr');
        tr.className='border-b';
        const logs = item.logs.map(l=>`<div class='mb-1'><span class='text-xs text-gray-500 mr-2'>${l.date}</span>${l.text}</div>`).join('');
        tr.innerHTML = `
          <td class='px-4 py-3 text-sm'>${item.group}조</td>
          <td class='px-4 py-3 text-sm font-medium'>${item.name}</td>
          <td class='px-4 py-3 text-sm'>${logs}</td>
          <td class='px-4 py-3 text-sm text-gray-700'>${item.summary}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('weeklyPageInfo').textContent = `${weeklyPage+1} / ${weeklyMaxPage+1}`;
    }

    // 일별 스크럼 표
    function renderDailyTable(date){
      document.getElementById('dailySelect').value = date;
      const rows = DAILY[date];
      const groupVal = document.getElementById('dailyGroupFilter').value;
      const q = (document.getElementById('dailySearch').value || '').toLowerCase();
      let list = rows.slice();
      if (groupVal !== 'all') list = list.filter(r => String(r.group) === groupVal);
      if (q) list = list.filter(r => r.name.toLowerCase().includes(q) || r.task.toLowerCase().includes(q));

      dailyMaxPage = Math.max(0, Math.ceil(list.length / PAGE_SIZE) - 1);
      dailyPage = Math.min(dailyPage, dailyMaxPage);
      const start = dailyPage * PAGE_SIZE;
      const pageItems = list.slice(start, start + PAGE_SIZE);

      const tbody = document.getElementById('dailyTbody');
      tbody.innerHTML = '';
      pageItems.forEach(r => {
        const tr = document.createElement('tr');
        tr.className='border-b';
        const badge = r.status==='완료' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700';
        tr.innerHTML = `
          <td class='px-4 py-3 text-sm'>${r.name}</td>
          <td class='px-4 py-3 text-sm'>${r.group}조</td>
          <td class='px-4 py-3 text-sm'>${r.task}</td>
          <td class='px-4 py-3 text-sm'>${r.perspective}</td>
          <td class='px-4 py-3 text-xs'><span class='px-2 py-1 rounded ${badge}'>${r.status}</span></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('dailyPageInfo').textContent = `${dailyPage+1} / ${dailyMaxPage+1}`;
    }

    // 수강생 상세
    let chartStudent, chartPerspective;
    function renderStudentDetail(name){
      const weekKey = document.getElementById('studentWeekSelect').value || WEEKLY_LOGS[0].weekKey;
      document.getElementById('studentSelect').value = name;
      document.getElementById('studentWeekSelect').value = weekKey;

      // 작성 추이(최근 7일)
      const recent7 = DAYS.slice(-7);
      const counts = recent7.map(d => DAILY[d].filter(x => x.name===name).length);
      chartStudent && chartStudent.destroy();
      chartStudent = new Chart(document.getElementById('chartStudent'), {
        type:'bar',
        data:{ labels: recent7, datasets:[{ label:'작성수', data:counts, backgroundColor:'#6366F1' }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });

      // 관점 분포(선택 주차의 노션 요약 기반, 샘플 분류)
      const week = WEEKLY_LOGS.find(w => w.weekKey===weekKey);
      const item = week.items.find(i => i.name===name) || { logs:[] };
      const perspectiveMap = groupBy(item.logs.map(l=>sampleTaskFor(name,l.date).perspective), x=>x);
      const labels = Object.keys(perspectiveMap);
      const values = labels.map(k=>perspectiveMap[k].length);
      chartPerspective && chartPerspective.destroy();
      chartPerspective = new Chart(document.getElementById('chartPerspective'), {
        type:'doughnut',
        data:{ labels, datasets:[{ data:values, backgroundColor:['#10B981','#F59E0B','#3B82F6','#F97316','#8B5CF6'] }] },
        options:{ responsive:true, maintainAspectRatio:false }
      });

      // 타임라인
      const container = document.getElementById('studentTimeline');
      container.innerHTML = '';
      (item.logs || []).forEach(l => {
        const div = document.createElement('div');
        div.className = 'border rounded-lg p-3';
        div.innerHTML = `<div class='text-xs text-gray-500'>${l.date}</div><div class='text-sm'>${l.text}</div>`;
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
